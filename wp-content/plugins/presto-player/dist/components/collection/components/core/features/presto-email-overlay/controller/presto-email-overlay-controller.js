import{h}from"@stencil/core";import{timePassed}from"../../../../../util";export class PrestoEmailOverlayController{constructor(){this.ended=void 0,this.currentTime=void 0,this.duration=void 0,this.direction=void 0,this.emailCollection=void 0,this.i18n=void 0,this.videoId=void 0,this.presetId=void 0,this.provider=void 0,this.enabled=void 0,this.show=void 0,this.loading=void 0,this.error=void 0,this.percentagePassed=0}setStorage(e){window.localStorage.setItem("presto.videos.email_collection",JSON.stringify({[this.videoId]:e}))}getStorage(){return window.localStorage.getItem("presto.videos.email_collection")}componentWillLoad(){this.handleDuration()}handleDuration(){var e;this.enabled=!this.getStorage()&&(null===(e=null==this?void 0:this.emailCollection)||void 0===e?void 0:e.enabled),this.handleTimeCheck()}handleTimeCheck(){this.enabled&&(this.getStorage()||this.checkTime())}handleShowChange(){this.show&&this.pauseVideo.emit(!0)}checkTime(){var e;this.show=timePassed({current:this.currentTime,duration:this.duration,showAfter:(null===(e=null==this?void 0:this.emailCollection)||void 0===e?void 0:e.percentage)||0})}async getNonce(){var e;return fetch(`${null===(e=null===window||void 0===window?void 0:window.prestoPlayer)||void 0===e?void 0:e.ajaxurl}?action=presto_refresh_progress_nonce`)}async submit(e){var t;this.loading=!0,this.error="";const i=await this.getNonce(),{data:o}=await i.json();try{let i=await fetch(null===(t=null===window||void 0===window?void 0:window.prestoPlayer)||void 0===t?void 0:t.ajaxurl,{method:"post",body:new URLSearchParams(Object.assign({action:"presto_player_email_submit",nonce:o,preset_id:this.presetId,video_id:this.videoId,provider:this.provider},(null==e?void 0:e.detail)||{}))});const{success:r,data:l}=await i.json();if(!r)throw l;this.setStorage("collected"),this.show=!1,this.playVideo.emit()}catch(e){const t=null==e?void 0:e[0];t&&"string"==typeof t&&(this.error=t)}finally{this.loading=!1}}skip(){this.setStorage("skipped"),this.show=!1,this.playVideo.emit()}handleEmailStateChange(e){this.emailStateChange.emit(e)}render(){var e,t,i,o,r,l,n,a;if(this.show)return h("presto-email-overlay-ui",{style:Object.assign(Object.assign({},(null===(e=null==this?void 0:this.emailCollection)||void 0===e?void 0:e.button_color)?{"--presto-player-button-color":`${null===(t=null==this?void 0:this.emailCollection)||void 0===t?void 0:t.button_color}`}:{}),(null===(i=null==this?void 0:this.emailCollection)||void 0===i?void 0:i.button_text_color)?{"--presto-player-button-text":`${null===(o=null==this?void 0:this.emailCollection)||void 0===o?void 0:o.button_text_color}`}:{}),direction:this.direction,class:"email-overlay",headline:null===(r=null==this?void 0:this.emailCollection)||void 0===r?void 0:r.headline,bottomText:null===(l=null==this?void 0:this.emailCollection)||void 0===l?void 0:l.bottom_text,allowSkip:null===(n=null==this?void 0:this.emailCollection)||void 0===n?void 0:n.allow_skip,buttonText:null===(a=null==this?void 0:this.emailCollection)||void 0===a?void 0:a.button_text,isLoading:this.loading,errorMessage:this.error,onSubmitForm:e=>this.submit(e),onSkip:()=>this.skip(),i18n:this.i18n,provider:this.provider})}static get is(){return"presto-email-overlay-controller"}static get originalStyleUrls(){return{$:["presto-email-overlay-controller.css"]}}static get styleUrls(){return{$:["presto-email-overlay-controller.css"]}}static get properties(){return{ended:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"ended",reflect:!1},currentTime:{type:"number",mutable:!1,complexType:{original:"number",resolved:"number",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"current-time",reflect:!0},duration:{type:"number",mutable:!1,complexType:{original:"number",resolved:"number",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"duration",reflect:!0},direction:{type:"string",mutable:!1,complexType:{original:"'rtl'",resolved:'"rtl"',references:{}},required:!1,optional:!0,docs:{tags:[],text:""},attribute:"direction",reflect:!1},emailCollection:{type:"unknown",mutable:!1,complexType:{original:"EmailCollection",resolved:"EmailCollection",references:{EmailCollection:{location:"import",path:"../../../../../interfaces"}}},required:!1,optional:!0,docs:{tags:[],text:""}},i18n:{type:"unknown",mutable:!1,complexType:{original:"i18nConfig",resolved:"i18nConfig",references:{i18nConfig:{location:"import",path:"../../../../../interfaces"}}},required:!1,optional:!1,docs:{tags:[],text:""}},videoId:{type:"number",mutable:!1,complexType:{original:"number",resolved:"number",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"video-id",reflect:!1},presetId:{type:"number",mutable:!1,complexType:{original:"number",resolved:"number",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"preset-id",reflect:!1},provider:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"provider",reflect:!1}}}static get states(){return{enabled:{},show:{},loading:{},error:{},percentagePassed:{}}}static get events(){return[{method:"playVideo",name:"playVideo",bubbles:!0,cancelable:!0,composed:!0,docs:{tags:[],text:""},complexType:{original:"void",resolved:"void",references:{}}},{method:"pauseVideo",name:"pauseVideo",bubbles:!0,cancelable:!0,composed:!0,docs:{tags:[],text:""},complexType:{original:"true",resolved:"boolean",references:{}}},{method:"restartVideo",name:"restartVideo",bubbles:!0,cancelable:!0,composed:!0,docs:{tags:[],text:""},complexType:{original:"void",resolved:"void",references:{}}},{method:"emailStateChange",name:"emailStateChange",bubbles:!0,cancelable:!0,composed:!0,docs:{tags:[],text:""},complexType:{original:"boolean",resolved:"boolean",references:{}}}]}static get watchers(){return[{propName:"duration",methodName:"handleDuration"},{propName:"currentTime",methodName:"handleTimeCheck"},{propName:"currentTime",methodName:"handleShowChange"},{propName:"show",methodName:"handleEmailStateChange"}]}}