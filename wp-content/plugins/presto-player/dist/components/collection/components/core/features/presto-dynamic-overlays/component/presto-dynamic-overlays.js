import{h}from"@stencil/core";import{timeToSeconds,parseColor}from"../../../../../util";export class PrestoDynamicOverlays{constructor(){this.watermarkRef={left:null,right:null},this.refs={},this.overlays=void 0,this.player=void 0,this.preset=void 0,this.enabled=void 0,this.currentTime=void 0,this.destroy=!1}componentDidLoad(){this.player&&this.player.on("timeupdate",(e=>{this.currentTime=e.detail.plyr.currentTime,this.checkValidity()}))}checkValidity(){var e,t,o,r,i,l,s,a,n,d;this.player.playing&&((null===(e=null==this?void 0:this.overlays)||void 0===e?void 0:e.length)||(null===(o=null===(t=this.preset)||void 0===t?void 0:t.watermark)||void 0===o?void 0:o.enabled))&&((null===(r=this.container)||void 0===r?void 0:r.offsetParent)&&(null===(i=this.topLeft)||void 0===i?void 0:i.offsetParent)&&(null===(l=this.topRight)||void 0===l?void 0:l.offsetParent)||this.reloadComponent.emit(),Object.keys(this.refs||{}).forEach((e=>{const{overlay:t,component:o}=this.refs[e];this.checkComponent(o,t.text,(()=>this.reloadComponent.emit()))})),this.shouldShowWatermark("top-left")&&this.watermarkRef.left&&this.checkComponent(this.watermarkRef.left,null===(a=null===(s=this.preset)||void 0===s?void 0:s.watermark)||void 0===a?void 0:a.text,(()=>this.reloadComponent.emit())),this.shouldShowWatermark("top-right")&&this.watermarkRef.right&&this.checkComponent(this.watermarkRef.right,null===(d=null===(n=this.preset)||void 0===n?void 0:n.watermark)||void 0===d?void 0:d.text,(()=>this.reloadComponent.emit())))}checkComponent(e,t,o){if(!(null==e?void 0:e.offsetParent))return o();if(!e.shadowRoot.querySelector("slot"))return o();if(this.player&&this.player.playing){const r=e.shadowRoot.querySelector("slot").assignedNodes()[0];if(r){if(r.parentElement.innerHTML!=t)return o();const e=getComputedStyle(r.parentElement.shadowRoot.querySelector(".overlay-text"));if(parseInt(e.fontSize,10)<10)return o();const i=parseColor(e.color);if("1"!==(null==i?void 0:i[3]))return o()}}}shouldShowOverlay(e){if(void 0!==this.currentTime)return!(this.currentTime<timeToSeconds(null==e?void 0:e.startTime)||this.currentTime>timeToSeconds(null==e?void 0:e.endTime))}renderOverlay(e){var t,o;return h("presto-dynamic-overlay-ui",{class:{visible:this.shouldShowOverlay(e)},ref:t=>this.refs[e.id]={overlay:e,component:t},key:e.id,position:e.position,href:null===(t=null==e?void 0:e.link)||void 0===t?void 0:t.url,target:(null===(o=null==e?void 0:e.link)||void 0===o?void 0:o.opensInNewTab)?"_blank":"_self",innerHTML:this.shouldShowOverlay(e)?e.text:"",style:{"--presto-dynamic-overlay-color":(null==e?void 0:e.color)||"#fff","--presto-dynamic-overlay-background":(null==e?void 0:e.backgroundColor)||"#333","--presto-dynamic-overlay-opacity":(null==e?void 0:e.opacity)?(e.opacity/100).toString():"1"}})}shouldShowWatermark(e){var t,o,r;if(!(null===(o=null===(t=this.preset)||void 0===t?void 0:t.watermark)||void 0===o?void 0:o.enabled))return!1;const i=null===(r=this.preset)||void 0===r?void 0:r.watermark;return"randomize"===i.position?Math.floor((this.player.currentTime||0)/10)%2==0?"top-left"===e:"top-right"===e:i.position===e||!i.position&&"top-right"===e}render(){var e,t,o,r,i,l,s,a,n,d,p;if(this.enabled&&((null===(e=null==this?void 0:this.overlays)||void 0===e?void 0:e.length)||(null===(o=null===(t=this.preset)||void 0===t?void 0:t.watermark)||void 0===o?void 0:o.enabled)))return h("div",{class:"overlays",ref:e=>this.container=e},h("div",{class:"top-left",ref:e=>this.topLeft=e},!!this.shouldShowWatermark("top-left")&&h("presto-dynamic-overlay-ui",{ref:e=>this.watermarkRef.left=e,style:{"--presto-dynamic-overlay-color":(null===(r=this.preset.watermark)||void 0===r?void 0:r.color)||"#fff","--presto-dynamic-overlay-background":(null===(i=this.preset.watermark)||void 0===i?void 0:i.backgroundColor)||"#333","--presto-dynamic-overlay-opacity":(null===(l=this.preset.watermark)||void 0===l?void 0:l.opacity)?(this.preset.watermark.opacity/100).toString():"1"},class:"visible",position:"top-left",innerHTML:this.preset.watermark.text}),!!(null===(s=null==this?void 0:this.overlays)||void 0===s?void 0:s.length)&&this.overlays.map((e=>"top-left"!==e.position?"":this.renderOverlay(e)))),h("div",{class:"top-right",ref:e=>this.topRight=e},!!this.shouldShowWatermark("top-right")&&h("presto-dynamic-overlay-ui",{ref:e=>this.watermarkRef.right=e,style:{"--presto-dynamic-overlay-color":(null===(a=this.preset.watermark)||void 0===a?void 0:a.color)||"#fff","--presto-dynamic-overlay-background":(null===(n=this.preset.watermark)||void 0===n?void 0:n.backgroundColor)||"#333","--presto-dynamic-overlay-opacity":(null===(d=this.preset.watermark)||void 0===d?void 0:d.opacity)?(this.preset.watermark.opacity/100).toString():"1"},class:"visible",position:"top-right",innerHTML:this.preset.watermark.text}),!!(null===(p=null==this?void 0:this.overlays)||void 0===p?void 0:p.length)&&this.overlays.map((e=>"top-right"!==e.position?"":this.renderOverlay(e)))))}static get is(){return"presto-dynamic-overlays"}static get encapsulation(){return"shadow"}static get originalStyleUrls(){return{$:["presto-dynamic-overlays.scss"]}}static get styleUrls(){return{$:["presto-dynamic-overlays.css"]}}static get properties(){return{overlays:{type:"unknown",mutable:!1,complexType:{original:"Array<DynamicOverlay>",resolved:"DynamicOverlay[]",references:{Array:{location:"global"},DynamicOverlay:{location:"import",path:"../../../../../interfaces"}}},required:!1,optional:!1,docs:{tags:[],text:""}},player:{type:"any",mutable:!1,complexType:{original:"any",resolved:"any",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"player",reflect:!1},preset:{type:"unknown",mutable:!1,complexType:{original:"presetAttributes",resolved:"presetAttributes",references:{presetAttributes:{location:"import",path:"../../../../../interfaces"}}},required:!1,optional:!1,docs:{tags:[],text:""}},enabled:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"enabled",reflect:!1}}}static get states(){return{currentTime:{},destroy:{}}}static get events(){return[{method:"reloadComponent",name:"reloadComponent",bubbles:!0,cancelable:!0,composed:!0,docs:{tags:[],text:""},complexType:{original:"void",resolved:"void",references:{}}}]}static get elementRef(){return"el"}}